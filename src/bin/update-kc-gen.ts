import * as crypto from 'crypto';
import * as fs from 'fs';
import { join as pathJoin } from 'path';
import type { BuildContext } from './core';
import { getIsPrettierAvailable, runPrettier } from './tools/runPrettier';

export async function command(params: { buildContext: BuildContext }) {
  const { buildContext } = params;

  const filePath = pathJoin(buildContext.themeSrcDirPath, 'kc.gen.ts');
  const svelteFilePath = pathJoin(buildContext.themeSrcDirPath, 'kc.gen.svelte');

  const implementedThemeTypes = (['login', 'account'] as const).filter(
    (themeType) => buildContext.implementedThemeTypes[themeType].isImplemented,
  );

  const newContent = [
    `/* eslint-disable */`,
    ``,
    `// @ts-nocheck`,
    ``,
    `// noinspection JSUnusedGlobalSymbols`,
    ``,
    `export type ThemeName = ${buildContext.themeNames.map((themeName) => `"${themeName}"`).join(' | ')};`,
    ``,
    `export const themeNames: ThemeName[] = [${buildContext.themeNames.map((themeName) => `"${themeName}"`).join(', ')}];`,
    ``,
    `export type KcEnvName = ${buildContext.environmentVariables.length === 0 ? 'never' : buildContext.environmentVariables.map(({ name }) => `"${name}"`).join(' | ')};`,
    ``,
    `export const kcEnvNames: KcEnvName[] = [${buildContext.environmentVariables.map(({ name }) => `"${name}"`).join(', ')}];`,
    ``,
    `export const kcEnvDefaults: Record<KcEnvName, string> = ${JSON.stringify(
      Object.fromEntries(
        buildContext.environmentVariables.map(({ name, default: defaultValue }) => [name, defaultValue]),
      ),
      null,
      2,
    )};`,
    ``,
    `export type KcContext =`,
    ...implementedThemeTypes.map((themeType) => `    | import("./${themeType}/KcContext").KcContext`),
    `    ;`,
    ``,
    `declare global {`,
    `    interface Window {`,
    `        kcContext?: KcContext;`,
    `    }`,
    `}`,
    ``,
  ].join('\n');

  const newSvelteContent = [
    `  import type { Component } from 'svelte';`,
    `  import type { KcContext } from './kc.gen';`,
    ``,
    `  const props: { kcContext: KcContext; Fallback?: Component } = $props();`,
    ``,
    `  const KcLoginPage = import('./login/KcPage.svelte');`,
    `  const { kcContext } = props;`,
    `</script>`,
    ``,
    `{#if kcContext.themeType === 'login'}`,
    `  {#await KcLoginPage}`,
    `    {#if props.Fallback}`,
    `      <props.Fallback></props.Fallback>`,
    `    {/if}`,
    `  {:then { default: KcPage }}`,
    `    <KcPage {kcContext} />`,
    `  {/await}`,
    `{:else}`,
    `  null`,
    `{/if}`,
  ].join('\n');

  const hash = crypto.createHash('sha256').update(newContent).digest('hex');

  skip_if_no_changes: {
    if (!fs.existsSync(filePath)) {
      break skip_if_no_changes;
    }

    const currentContent = fs.readFileSync(filePath).toString('utf8');

    if (!currentContent.includes(hash)) {
      break skip_if_no_changes;
    }

    return;
  }

  let sourceCode = [
    `// This file is auto-generated by keycloakify. Do not edit it manually.`,
    `// Hash: ${hash}`,
    ``,
    newContent,
  ].join('\n');

  let svelteSourceCode = [
    `<script lang="ts">`,
    `// This file is auto-generated by keycloakify. Do not edit it manually.`,
    `// Hash: ${hash}`,
    ``,
    newSvelteContent,
  ].join('\n');

  run_prettier: {
    if (!(await getIsPrettierAvailable())) {
      break run_prettier;
    }

    sourceCode = await runPrettier({
      filePath,
      sourceCode,
    });
    svelteSourceCode = await runPrettier({
      filePath: svelteFilePath,
      sourceCode: svelteSourceCode,
    });
  }

  fs.writeFileSync(filePath, Buffer.from(sourceCode, 'utf8'));
  fs.writeFileSync(svelteFilePath, Buffer.from(svelteSourceCode, 'utf8'));
}
